name: 'Terraform Deploy'

on:
  push:
    branches: ["main"]
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-deploy.yml'
  pull_request:
    branches: ["main"]
    paths:
      - 'terraform/**'
  workflow_dispatch:

# WORKFLOW-LEVEL: Shared, non-sensitive variables only
env:
  TERRAFORM_VERSION: "~> 1.5"
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_REGION: "eastus"
  RESOURCE_GROUP: "elekta-devops-test"

permissions:
  contents: read
  pull-requests: write

jobs:
  # =======================
  # STAGE 1: VALIDATION
  # =======================
  validate:
    name: 'Terraform Validation'
    runs-on: ubuntu-latest
    
    #JOB-LEVEL: Only credentials needed for this job
    env:
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
    
    defaults:
      run:
        working-directory: ./terraform

    outputs:
      plan-file: ${{ steps.plan.outputs.stdout }}

    steps:
      - name: 'Checkout Code'
        uses: actions/checkout@v4

      - name: 'Setup Terraform'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: 'Terraform Format Check'
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: 'Terraform Init'
        id: init
        run: |
          terraform init \
            -backend-config="resource_group_name=rg-terraform-state" \
            -backend-config="storage_account_name=tfstatestgelekta" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=prod.terraform.tfstate"

      - name: 'Terraform Validate'
        id: validate
        run: terraform validate -no-color

      - name: 'Terraform Security Scan (tfsec)'
        id: tfsec
        run: |
          echo "Installing tfsec for infrastructure security scanning..."
          wget -q https://github.com/aquasecurity/tfsec/releases/download/v1.28.0/tfsec-linux-amd64
          chmod +x tfsec-linux-amd64
          
          echo "Running tfsec security scan..."
          ./tfsec-linux-amd64 . -f json > tfsec-results.json 2>&1 || true
          ./tfsec-linux-amd64 . --minimum-severity MEDIUM || true
        continue-on-error: true

      - name: 'Policy Compliance Check (Checkov)'
        id: checkov
        run: |
          echo "Installing Checkov for compliance validation..."
          pip install checkov -q
          
          echo "Running compliance checks..."
          checkov -d . --framework terraform --quiet --output cli || true
        continue-on-error: true

      - name: 'Validation Summary'
        run: |
          echo "## âœ… Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Format Check | ${{ steps.fmt.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Init | ${{ steps.init.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Syntax Validation | ${{ steps.validate.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan (tfsec) | ${{ steps.tfsec.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Compliance (Checkov) | ${{ steps.checkov.outcome }} |" >> $GITHUB_STEP_SUMMARY

  # =======================
  # STAGE 2: PLAN
  # =======================
  plan:
    name: 'Terraform Plan'
    needs: validate
    runs-on: ubuntu-latest
    
    #JOB-LEVEL: Credentials needed for planning
    env:
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      TF_VAR_azure_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      TF_VAR_admin_password: ${{ secrets.ADMIN_PASSWORD }}
    
    defaults:
      run:
        working-directory: ./terraform

    steps:
      - name: 'Checkout Code'
        uses: actions/checkout@v4

      - name: 'Setup Terraform'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: 'Terraform Init'
        run: |
          terraform init \
            -backend-config="resource_group_name=rg-terraform-state" \
            -backend-config="storage_account_name=tfstatestgelekta" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=prod.terraform.tfstate"

      - name: 'Terraform Plan'
        id: plan
        run: terraform plan -no-color -input=false -out=tfplan
        continue-on-error: true

      - name: 'Upload Plan Artifact'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: terraform/tfplan
          retention-days: 1

      - name: 'Comment Plan on Pull Request'
        if: github.event_name == 'pull_request' && steps.plan.outcome == 'success'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `#### Terraform Plan ðŸ“–

            **Status**: âœ… Plan completed successfully

            **Next Steps**:
            1. Review the plan output above
            2. Merge this PR to trigger deployment to production
            3. **âš ï¸ Note**: Deployment requires manual approval in the production environment

            **Plan Artifact**: Available in workflow run for reference`
            })

  # =======================
  # STAGE 3: DEPLOY
  # (Requires Manual Approval)
  # =======================
  deploy:
    name: 'Terraform Apply'
    needs: plan
    runs-on: ubuntu-latest
    
    #PRODUCTION ENVIRONMENT - REQUIRES MANUAL APPROVAL
    environment:
      name: production
      url: https://portal.azure.com
    
    # Only deploy on push to main (not on PRs)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    # JOB-LEVEL: All credentials needed for deployment
    env:
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      TF_VAR_azure_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      TF_VAR_admin_password: ${{ secrets.ADMIN_PASSWORD }}
    
    defaults:
      run:
        working-directory: ./terraform

    steps:
      - name: 'Checkout Code'
        uses: actions/checkout@v4

      - name: 'Setup Terraform'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: 'Terraform Init'
        run: |
          terraform init \
            -backend-config="resource_group_name=rg-terraform-state" \
            -backend-config="storage_account_name=tfstatestgelekta" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=prod.terraform.tfstate"

      - name: 'Terraform Plan (Pre-Apply Validation)'
        id: pre_apply_plan
        run: terraform plan -no-color -input=false
        continue-on-error: true

      - name: 'Terraform Apply'
        id: apply
        run: terraform apply -auto-approve -no-color -input=false

      - name: 'Capture Terraform Outputs'
        id: outputs
        run: |
          terraform output -json > outputs.json
          cat outputs.json

      - name: 'Deployment Summary'
        if: success()
        run: |
          echo "## ðŸŽ‰ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Infrastructure Deployed to Azure" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Group**: ${{ env.RESOURCE_GROUP }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region**: ${{ env.AZURE_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Resources:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          terraform output >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "- Verify infrastructure in [Azure Portal](https://portal.azure.com)" >> $GITHUB_STEP_SUMMARY
          echo "- Test RDP connectivity to VMs" >> $GITHUB_STEP_SUMMARY
          echo "- Validate inter-VM communication" >> $GITHUB_STEP_SUMMARY

  # =======================
  # STAGE 4: POST-DEPLOYMENT VALIDATION
  # =======================
  validate-deployment:
    name: 'Post-Deployment Validation'
    needs: deploy
    runs-on: ubuntu-latest
  
    if: success()
  
    #Use environment variables you already have
    env:
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  
    steps:
      - name: 'Checkout Code'
        uses: actions/checkout@v4

      - name: 'Setup Azure CLI'
        uses: azure/setup-azure-cli@v3
        with:
          azcliversion: 'latest'

      - name: 'Authenticate to Azure'
        run: |
          az login --service-principal \
            -u ${{ secrets.AZURE_CLIENT_ID }} \
            -p ${{ secrets.AZURE_CLIENT_SECRET }} \
            --tenant ${{ secrets.AZURE_TENANT_ID }}

      - name: 'Verify Resource Group'
        run: |
          echo "Verifying resource group exists..."
          az group show --name elekta-devops-test --output table
        continue-on-error: true

      - name: 'Verify Virtual Machines'
        run: |
          echo "Verifying VMs are running..."
          az vm list --resource-group elekta-devops-test --output table
        
          echo "Checking VM status..."
          az vm get-instance-view --name vm-test-1 --resource-group elekta-devops-test --query "instanceView.statuses[*].displayStatus" --output table
          az vm get-instance-view --name vm-test-2 --resource-group elekta-devops-test --query "instanceView.statuses[*].displayStatus" --output table
        continue-on-error: true

      - name: 'Verify Network Configuration'
        run: |
          echo "Verifying virtual network..."
          az network vnet list --resource-group elekta-devops-test --output table
        
          echo "Verifying subnet..."
          az network vnet subnet list --resource-group elekta-devops-test --vnet-name vnet-prod --output table
        
          echo "Verifying Network Security Group..."
          az network nsg list --resource-group elekta-devops-test --output table
        continue-on-error: true

      - name: 'Post-Deployment Validation Summary'
        run: |
          echo "## âœ… Post-Deployment Validation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Infrastructure has been successfully deployed and is operational." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Validation Checks Performed:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Resource group exists and is accessible" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Virtual machines are deployed and running" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Network configuration is in place" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Security groups are properly configured" >> $GITHUB_STEP_SUMMARY